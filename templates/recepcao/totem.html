{% extends 'base.html' %}
{% load static %}

{% block title %}Totem de Visitas{% endblock %}

{% block content %}
<div class="container-fluid vh-100 bg-light">
    <!-- Botão fora do card, alinhado à direita -->
    <div class="w-100 d-flex justify-content-end" style="max-width: 900px; margin: 2rem auto 0.5rem auto;">
        <a href="{% url 'recepcao:home_recepcao' %}" class="btn btn-light btn-xs"
           style="border-radius: 0.6rem; color: #444; border: 1px solid #ccc; font-weight: 500; font-size: 0.98rem; padding: 0.35rem 0.9rem;">
            <i class="fas fa-arrow-left me-2"></i>Voltar para Recepção
        </a>
    </div>
    <!-- Card branco centralizado -->
    <div class="d-flex flex-column align-items-center justify-content-center w-100" style="max-width: 420px; margin: 0 auto;">
        <h2 class="mb-3 mt-2 fw-bold text-primary text-center" style="font-size: 1.5rem;">
            <i class="fas fa-camera me-2"></i>Posicione seu rosto para identificação
        </h2>
        <div class="camera-area-totem mb-3 position-relative mx-auto bg-white shadow-sm" style="border: 3px solid #007bff; border-radius: 1.5rem;">
            <video id="video" autoplay playsinline class="rounded-4 border-0 totem-video" style="background:#222;"></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <div id="faceGuide" class="face-guide-totem"></div>
            <div id="dicas" class="dicas-totem">
                <i class="fas fa-lightbulb me-2"></i> Posicione seu rosto dentro do guia amarelo
            </div>
        </div>
        <div class="status-mensagens mb-2 w-100">
            <div id="statusReconhecimento" class="alert alert-info w-100 mb-2 p-2" aria-live="polite" style="background:#e3f6fd;color:#007bff;font-size:1rem;">
                <i class="fas fa-info-circle me-2"></i>Olhe diretamente para a câmera
            </div>
            <div id="mensagem-camera" class="alert alert-info w-100 p-2" style="background:#e3f6fd;color:#007bff;font-size:1rem;">
                Posicione seu rosto no centro da tela
            </div>
        </div>
        <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
            <button id="btnReiniciarCamera" class="btn btn-warning btn-sm fw-bold botao-pequeno" style="font-size:1rem;">
                <i class="fas fa-sync-alt me-2"></i> Reiniciar Câmera
            </button>
        </div>
        <button id="btnIniciarReconhecimento" class="btn btn-primary btn-md fw-bold w-100 mb-2" style="font-size:1.1rem;">
            <i class="fas fa-search me-2"></i>Iniciar Reconhecimento
        </button>
        <div id="result" class="mt-2 w-100" aria-live="polite"></div>
        <!-- Modal de sucesso -->
        <div id="modalSucesso" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content p-4 text-center" style="border-radius:1.5rem; border:3px solid #28a745; box-shadow:0 4px 32px rgba(40,167,69,0.10);">
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="d-inline-block bg-success text-white rounded-circle p-3 mb-2" style="font-size:2.5rem;">
                                <i class="fas fa-check"></i>
                            </span>
                        </div>
                        <h4 id="modalNomeVisitante" class="fw-bold text-success mb-2"></h4>
                        <div class="mb-2 text-secondary" style="font-size:1.1rem;">
                            <i class="fas fa-smile-beam me-2"></i>Reconhecimento bem-sucedido! Bem-vindo(a)!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% csrf_token %}
{% endblock %}

{% block extra_css %}
<style>
.totem-device {
    background: none;
    box-shadow: none;
    border-radius: 0;
    padding: 0;
    max-width: unset;
    min-height: unset;
    max-height: unset;
    position: static;
    display: block;
}
.totem-screen {
    background: none;
    box-shadow: none;
    border-radius: 0;
    padding: 0;
    min-height: unset;
    max-width: unset;
    max-height: unset;
    width: 100%;
    position: static;
    overflow: visible;
    display: block;
    gap: 0;
}
.camera-area-totem {
    position: relative;
    width: 320px;
    height: 400px;
    margin: 0 auto 1.2rem auto;
    background: #fff;
    border-radius: 1.5rem;
    border: 3px solid #007bff;
    box-shadow: 0 2px 16px 0 rgba(0,0,0,0.08);
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
}
.totem-video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
    border-radius: 1.5rem;
    background: #222;
    display: block;
}
.face-guide-totem {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 180px;
    height: 240px;
    border: 4px dashed #ffe066;
    border-radius: 50% 50% 40% 40%;
    pointer-events: none;
    z-index: 2;
}
.dicas-totem {
    position: absolute;
    bottom: 16px;
    left: 0;
    right: 0;
    text-align: center;
    background-color: rgba(0,0,0,0.7);
    color: #fff;
    padding: 10px 0;
    font-size: 1rem;
    border-radius: 0 0 1.5rem 1.5rem;
    z-index: 3;
}
.status-mensagens {
    width: 100%;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.status-mensagens .alert {
    font-size: 1rem;
    padding: 0.7rem 1.2rem;
    margin: 0;
    border-radius: 0.7rem;
    min-width: 180px;
    width: 100%;
    background: #e3f6fd;
    color: #007bff;
    border: none;
    text-align: left;
    box-shadow: none;
}
.btn-md, .btn-lg, .btn {
    font-size: 1.1rem !important;
    padding: 0.9rem 1.2rem !important;
    border-radius: 0.7rem !important;
    font-weight: 600;
}
.btn-danger {
    width: 100%;
    margin-bottom: 0.5rem;
}
.btn-outline-primary {
    width: 100%;
    margin-bottom: 0.5rem;
}
.row.gap-btns, .row.w-100.g-2 {
    width: 100%;
    margin: 0;
    gap: 0.5rem;
}
.row.gap-btns .col-12, .row.gap-btns .col-md-6, .row.w-100.g-2 .col-6 {
    padding: 0;
}
.btn-warning, .btn-info {
    width: 100%;
}
.btn-secondary {
    width: 100%;
    margin-top: 0.5rem;
}
.botao-pequeno {
    min-width: 140px;
    max-width: 180px;
    width: 160px;
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
    text-align: center;
}
@media (max-width: 600px) {
    .totem-device, .totem-screen {
        max-width: 98vw;
        width: 100vw;
        min-width: unset;
        min-height: 400px;
        max-height: unset;
        padding: 0.5rem;
    }
    .totem-screen {
        min-height: 500px;
        max-width: 98vw;
        max-height: unset;
        padding: 1rem;
    }
    .camera-area-totem {
        width: 98vw;
        height: 60vw;
        min-height: 220px;
        max-height: 70vw;
    }
    .totem-video {
        width: 100% !important;
        height: 100% !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultDiv = document.getElementById('result');
    const faceGuide = document.getElementById('faceGuide');
    const btnIniciar = document.getElementById('btnIniciarReconhecimento');
    let stream = null;
    let cameraActive = false;
    let reconhecimentoAtivo = false;
    let reconhecimentoInterval = null;

    // Iniciar câmera
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            cameraActive = true;
        } catch (err) {
            resultDiv.innerHTML = '<span style="color:red;">Erro ao acessar a câmera: ' + err.message + '</span>';
        }
    }

    // Parar câmera
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            cameraActive = false;
        }
    }

    // Iniciar reconhecimento ao clicar
    btnIniciar.addEventListener('click', function() {
        if (!cameraActive) {
            resultDiv.innerHTML = '<span style="color:red;">Câmera não está ativa!</span>';
            return;
        }
        btnIniciar.disabled = true;
        reconhecimentoAtivo = true;
        resultDiv.innerHTML = '<span style="color:#007bff;">Posicione seu rosto na frente da câmera.</span>';
        faceGuide.style.borderColor = '#ffe066';
        reconhecimentoInterval = setInterval(capturarReconhecer, 2000);
    });

    // Fluxo de reconhecimento/cadastro
    async function capturarReconhecer() {
        if (!stream || !cameraActive || !reconhecimentoAtivo) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        canvas.toBlob(async function(blob) {
            resultDiv.innerHTML = '<span style="color:#007bff;">Processando imagem...</span>';
            const formData = new FormData();
            formData.append('face_image', blob, 'face.jpg');
            try {
                const response = await fetch('/recepcao/api/verificar-face/', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success && data.faces_detected && data.faces_detected.length > 0 && data.faces_detected[0].visitante_id) {
                    // Visitante reconhecido
                    const nome = data.faces_detected[0].nome || 'usuário';
                    resultDiv.innerHTML = '';
                    faceGuide.style.borderColor = '#28a745'; // verde
                    reconhecimentoAtivo = false;
                    clearInterval(reconhecimentoInterval);
                    mostrarModalSucesso(nome, () => {
                        window.location.href = `/recepcao/totem/setor/?visitante_id=${data.faces_detected[0].visitante_id}`;
                    });
                } else if (data.success && data.faces_detected && data.faces_detected.length === 0) {
                    // Nenhum rosto detectado
                    resultDiv.innerHTML = `<span style=\"color:red;\">Nenhum rosto detectado. Tente novamente!</span>`;
                    faceGuide.style.borderColor = '#dc3545'; // vermelho
                    reconhecimentoAtivo = false;
                    clearInterval(reconhecimentoInterval);
                    setTimeout(() => {
                        resultDiv.innerHTML = '<span style=\"color:#007bff;\">Posicione seu rosto na frente da câmera.</span>';
                        faceGuide.style.borderColor = '#ffe066';
                        reconhecimentoAtivo = true;
                        btnIniciar.disabled = false;
                    }, 2000);
                } else {
                    // Não reconhecido: cadastrar face e redirecionar para cadastro de visitante
                    resultDiv.innerHTML = `<span style=\"color:orange;\">Rosto não reconhecido. Redirecionando para cadastro...</span>`;
                    faceGuide.style.borderColor = '#ffe066';
                    reconhecimentoAtivo = false;
                    clearInterval(reconhecimentoInterval);
                    const cadastroForm = new FormData();
                    cadastroForm.append('face_image', blob, 'face.jpg');
                    fetch('/recepcao/api/cadastro-rapido/', {
                        method: 'POST',
                        body: cadastroForm
                    });
                    setTimeout(() => {
                        window.location.href = '/recepcao/cadastro-visitantes/';
                    }, 1200);
                }
            } catch (err) {
                resultDiv.innerHTML = `<span style=\"color:red;\">Erro ao enviar imagem: ${err.message}</span>`;
                faceGuide.style.borderColor = '#dc3545';
                reconhecimentoAtivo = false;
                clearInterval(reconhecimentoInterval);
                btnIniciar.disabled = false;
            }
        }, 'image/jpeg', 0.9);
    }

    // Botão de reiniciar câmera
    document.getElementById('btnReiniciarCamera').addEventListener('click', startCamera);

    // Iniciar câmera ao carregar
    await startCamera();

    // Função para mostrar modal de sucesso
    function mostrarModalSucesso(nome, callback) {
        const modal = document.getElementById('modalSucesso');
        const nomeSpan = document.getElementById('modalNomeVisitante');
        nomeSpan.textContent = nome;
        modal.classList.add('show');
        modal.style.display = 'block';
        modal.removeAttribute('aria-hidden');
        setTimeout(() => {
            modal.classList.remove('show');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            if (callback) callback();
        }, 1200);
    }
});
</script>
{% endblock %}
