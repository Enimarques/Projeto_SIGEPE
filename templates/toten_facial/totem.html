{% extends 'base.html' %}
{% load static %}

{% block title %}Totem de Visitas{% endblock %}

{% block extra_css %}
<style>
body, html {
  min-height: 100vh;
  background: linear-gradient(135deg, #4f8cff 0%, #7b2ff2 100%);
  font-size: 18px;
}
.totem-card {
  max-width: 480px;
  width: 98vw;
  margin: 2rem auto;
  border-radius: 2rem;
  box-shadow: 0 8px 32px rgba(44, 62, 80, 0.15);
  padding: 2rem 1.5rem;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
}
input, select, button, textarea {
  font-size: 1.1rem;
  min-height: 48px;
  border-radius: 1rem;
}
button, .main-action-btn {
  min-width: 180px;
  min-height: 56px;
  font-size: 1.2rem;
  border-radius: 2rem;
}
.camera-area-totem {
  width: 100%;
  max-width: 380px;
  height: 260px;
  background: #222;
  border-radius: 1.5rem;
  margin: 0 auto 1rem auto;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}
.totem-video {
  width: 100%;
  height: 100%;
  border-radius: 1.5rem;
  object-fit: cover;
}
.face-guide-totem {
  position: absolute;
  top: 10%;
  left: 10%;
  width: 80%;
  height: 80%;
  border: 4px dashed #ffe066;
  border-radius: 50%;
  pointer-events: none;
  box-shadow: 0 0 0 4px rgba(255,255,255,0.1);
}
.status-mensagens .alert {
  font-size: 1.1rem;
  border-radius: 1rem;
  margin-bottom: 0.5rem;
}
.dicas-totem {
  color: #297793;
  font-size: 1.1rem;
  margin-top: 0.5rem;
  text-align: center;
}
@media (max-width: 900px) {
  .totem-card { max-width: 98vw; }
}
@media (max-width: 600px) {
  .totem-card { padding: 1rem 0.5rem; }
  .camera-area-totem { max-width: 98vw; height: 40vw; min-height: 180px; }
}
</style>
{% endblock %}

{% block content %}
<div class="totem-card">
    <!-- Botão Voltar padrão -->
    <div class="w-100 d-flex justify-content-end mb-3">
        {% include 'includes/botao_voltar.html' %}
    </div>
    <!-- Card centralizado -->
    <h2 class="mb-3 mt-2 fw-bold text-primary text-center" style="font-size: 2rem;">
        <i class="fas fa-camera me-2"></i>Posicione seu rosto para identificação
    </h2>
    <div class="camera-area-totem mb-3 position-relative mx-auto bg-white shadow-sm">
        <video id="video" autoplay playsinline class="rounded-4 border-0 totem-video" style="background:#222;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="faceGuide" class="face-guide-totem"></div>
        <div id="dicas" class="dicas-totem">
            <i class="fas fa-lightbulb me-2"></i> Posicione seu rosto dentro do guia amarelo
        </div>
    </div>
    <div class="status-mensagens mb-2 w-100">
        <div id="statusReconhecimento" class="alert alert-info w-100 mb-2 p-2" aria-live="polite" style="background:#e3f6fd;color:#007bff;font-size:1.1rem;">
            <i class="fas fa-info-circle me-2"></i>Olhe diretamente para a câmera
        </div>
        <div id="mensagem-camera" class="alert alert-info w-100 p-2" style="background:#e3f6fd;color:#007bff;font-size:1.1rem;">
            Posicione seu rosto no centro da tela
        </div>
    </div>
    <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
        <button id="btnReiniciarCamera" class="btn btn-warning btn-sm fw-bold botao-pequeno" style="font-size:1rem;">
            <i class="fas fa-sync-alt me-2"></i> Reiniciar Câmera
        </button>
    </div>
    <button id="btnIniciarReconhecimento" class="btn btn-primary btn-md fw-bold w-100 mb-2" style="font-size:1.1rem;">
        <i class="fas fa-search me-2"></i>Iniciar Reconhecimento
    </button>
    <div id="result" class="mt-2 w-100" aria-live="polite"></div>
    <!-- Modal de sucesso -->
    <div id="modalSucesso" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 text-center" style="border-radius:1.5rem; border:3px solid #28a745; box-shadow:0 4px 32px rgba(40,167,69,0.10);">
                <div class="modal-body">
                    <div class="mb-3">
                        <span class="d-inline-block bg-success text-white rounded-circle p-3 mb-2" style="font-size:2.5rem;">
                            <i class="fas fa-check"></i>
                        </span>
                    </div>
                    <h4 id="modalNomeVisitante" class="fw-bold text-success mb-2"></h4>
                    <div class="mb-2 text-secondary" style="font-size:1.1rem;">
                        <i class="fas fa-smile-beam me-2"></i>Reconhecimento bem-sucedido! Bem-vindo(a)!
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultDiv = document.getElementById('result');
    const faceGuide = document.getElementById('faceGuide');
    const btnIniciar = document.getElementById('btnIniciarReconhecimento');
    let stream = null;
    let cameraActive = false;
    let reconhecimentoAtivo = false;
    let reconhecimentoInterval = null;

    // Função para redimensionar a imagem capturada do vídeo
    function resizeImageFromVideo(video, width, height) {
        const canvasResize = document.createElement('canvas');
        canvasResize.width = width;
        canvasResize.height = height;
        const ctx = canvasResize.getContext('2d');
        ctx.drawImage(video, 0, 0, width, height);
        return canvasResize;
    }

    // Iniciar câmera
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            cameraActive = true;
        } catch (err) {
            resultDiv.innerHTML = '<span style="color:red;">Erro ao acessar a câmera: ' + err.message + '</span>';
        }
    }

    // Parar câmera
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            cameraActive = false;
        }
    }

    // Iniciar reconhecimento ao clicar
    btnIniciar.addEventListener('click', function() {
        if (!cameraActive) {
            resultDiv.innerHTML = '<span style="color:red;">Câmera não está ativa!</span>';
            return;
        }
        btnIniciar.disabled = true;
        reconhecimentoAtivo = true;
        resultDiv.innerHTML = '<span style="color:#007bff;">Posicione seu rosto na frente da câmera.</span>';
        faceGuide.style.borderColor = '#ffe066';
        reconhecimentoInterval = setInterval(capturarReconhecer, 2000);
    });

    // Fluxo de reconhecimento/cadastro
    async function capturarReconhecer() {
        if (!stream || !cameraActive || !reconhecimentoAtivo) return;
        // Redimensiona ANTES de enviar (480x360 pode ser ajustado para 320x240 se quiser mais leve)
        const resizedCanvas = resizeImageFromVideo(video, 480, 360);
        resizedCanvas.toBlob(async function(blob) {
            resultDiv.innerHTML = '<span style="color:#007bff;">Processando imagem...</span>';
            const formData = new FormData();
            formData.append('face_image', blob, 'face.jpg');
            try {
                const response = await fetch('/recepcao/api/verificar-face/', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success && data.faces_detected && data.faces_detected.length > 0 && data.faces_detected[0].visitante_id) {
                    // Visitante reconhecido
                    const nome = data.faces_detected[0].nome || 'usuário';
                    resultDiv.innerHTML = '';
                    faceGuide.style.borderColor = '#28a745'; // verde
                    reconhecimentoAtivo = false;
                    clearInterval(reconhecimentoInterval);
                    mostrarModalSucesso(nome, () => {
                        window.location.href = `/recepcao/totem/setor/?visitante_id=${data.faces_detected[0].visitante_id}`;
                    });
                } else if (data.success && data.faces_detected && data.faces_detected.length === 0) {
                    // Nenhum rosto detectado
                    resultDiv.innerHTML = `<span style=\"color:red;\">Nenhum rosto detectado. Tente novamente!</span>`;
                    faceGuide.style.borderColor = '#dc3545'; // vermelho
                    reconhecimentoAtivo = false;
                    clearInterval(reconhecimentoInterval);
                    setTimeout(() => {
                        resultDiv.innerHTML = '<span style=\"color:#007bff;\">Posicione seu rosto na frente da câmera.</span>';
                        faceGuide.style.borderColor = '#ffe066';
                        reconhecimentoAtivo = true;
                        btnIniciar.disabled = false;
                    }, 2000);
                } else {
                    // Não reconhecido: cadastrar face e redirecionar para cadastro de visitante
                    resultDiv.innerHTML = `<span style=\"color:orange;\">Rosto não reconhecido. Redirecionando para cadastro...</span>`;
                    faceGuide.style.borderColor = '#ffe066';
                    reconhecimentoAtivo = false;
                    clearInterval(reconhecimentoInterval);
                    const cadastroForm = new FormData();
                    cadastroForm.append('face_image', blob, 'face.jpg');
                    fetch('/recepcao/api/cadastro-rapido/', {
                        method: 'POST',
                        body: cadastroForm
                    });
                    setTimeout(() => {
                        window.location.href = '/recepcao/cadastro-visitantes/';
                    }, 1200);
                }
            } catch (err) {
                resultDiv.innerHTML = `<span style=\"color:red;\">Erro ao enviar imagem: ${err.message}</span>`;
                faceGuide.style.borderColor = '#dc3545';
                reconhecimentoAtivo = false;
                clearInterval(reconhecimentoInterval);
                btnIniciar.disabled = false;
            }
        }, 'image/jpeg', 0.8);
    }

    // Botão de reiniciar câmera
    document.getElementById('btnReiniciarCamera').addEventListener('click', startCamera);

    // Iniciar câmera ao carregar
    await startCamera();

    // Função para mostrar modal de sucesso
    function mostrarModalSucesso(nome, callback) {
        const modal = document.getElementById('modalSucesso');
        const nomeSpan = document.getElementById('modalNomeVisitante');
        nomeSpan.textContent = nome;
        modal.classList.add('show');
        modal.style.display = 'block';
        modal.removeAttribute('aria-hidden');
        setTimeout(() => {
            modal.classList.remove('show');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            if (callback) callback();
        }, 1200);
    }
});
</script>
{% endblock %}
