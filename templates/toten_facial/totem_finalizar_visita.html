{% extends 'base.html' %}
{% load static %}

{% block title %}Finalizar Visita{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: { primary: "#297793" },
      borderRadius: {
        md: "12px",
        xl: "20px",
        full: "9999px",
      },
    },
  },
};
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
<style>
body {
  background: linear-gradient(135deg, #f8fafc 0%, #e6f7f1 100%);
  min-height: 100vh;
}
.oval-guide {
  border: 4px dashed #FFD600;
  border-radius: 50%;
  pointer-events: none;
  box-shadow: 0 0 16px 4px #ffe06680;
  transition: border-color 0.3s;
}
#feedback .spinner {
  display: inline-block;
  width: 1.5em;
  height: 1.5em;
  border: 3px solid #b3d1ff;
  border-top: 3px solid #297793;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  vertical-align: middle;
  margin-right: 0.5em;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-transparent">
  <div class="w-full max-w-xl bg-white rounded-2xl shadow-xl p-8">
    <h2 class="text-2xl font-bold text-center text-primary mb-6 flex items-center justify-center gap-2">
      <i class="ri-camera-3-line"></i> Finalizar Visita
    </h2>
    <div class="relative flex justify-center mb-6">
      <div class="bg-black rounded-xl overflow-hidden w-72 h-80 flex items-center justify-center relative">
        <video id="video" width="320" height="240" autoplay playsinline class="absolute w-full h-full object-cover rounded-xl"></video>
        <svg class="absolute z-10 oval-guide" width="100%" height="100%" viewBox="0 0 288 320">
          <ellipse cx="144" cy="160" rx="100" ry="130" stroke="#FFD600" stroke-width="4" fill="none" stroke-dasharray="8 8"/>
        </svg>
        <div class="absolute bottom-0 left-0 w-full bg-black bg-opacity-60 text-white text-center py-2 text-sm flex items-center justify-center gap-2 z-20">
          <i class="ri-information-line"></i> Posicione seu rosto dentro do guia amarelo
        </div>
      </div>
    </div>
    <div class="flex flex-col gap-2 mb-6">
      <div class="flex items-center gap-2 text-blue-700 bg-blue-50 rounded-lg px-3 py-2">
        <i class="ri-eye-line"></i> Olhe diretamente para a câmera
      </div>
      <div class="flex items-center gap-2 text-blue-700 bg-blue-50 rounded-lg px-3 py-2">
        <i class="ri-focus-2-line"></i> Mantenha o rosto centralizado
      </div>
    </div>
    <div class="w-full text-center mt-2">
      <div id="feedback" class="text-blue-700 bg-blue-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2">
        <span class="spinner"></span> Aguardando detecção facial...
        <div id="dica-permissao" style="font-size:0.95em;color:#555;">Se a câmera não iniciar, permita o acesso no navegador.</div>
      </div>
    </div>
    <input type="hidden" name="visitante_id" id="visitante_id" value="">
    <a href="{% url 'recepcao:totem_home' %}" class="btn btn-outline-secondary btn-lg w-100 mt-6" style="font-size:1.2rem;min-height:56px;">
      <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const video = document.getElementById('video');
const feedback = document.getElementById('feedback');
let stream = null;
let reconhecido = false;

async function getPhysicalCameraDeviceId() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(device => device.kind === 'videoinput');
  // Permite qualquer câmera que não seja explicitamente virtual
  const physical = videoDevices.find(device =>
    device.label && !/virtual|obs|manycam|snap|droid|split|fake|epoc|xsplit/i.test(device.label)
  ) || videoDevices[0]; // fallback: pega a primeira se não encontrar nenhuma física clara
  if (!physical) {
    feedback.className = 'text-red-700 bg-red-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
    feedback.innerHTML = `
      <i class="ri-error-warning-line"></i> Nenhuma câmera encontrada.<br>
      <span>Conecte uma webcam física e feche/desative programas virtuais.</span>
    `;
    throw new Error('Nenhuma câmera encontrada.');
  }
  return physical.deviceId;
}

async function startCamera() {
  try {
    const deviceId = await getPhysicalCameraDeviceId();
    stream = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: { exact: deviceId }, width: 320, height: 240 }
    });
    video.srcObject = stream;
    video.play();
    feedback.innerHTML = '<span class="spinner"></span> Aguardando detecção facial...';
    detectarRosto();
  } catch (err) {
    feedback.className = 'text-red-700 bg-red-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
    feedback.innerHTML = `<i class="ri-error-warning-line"></i> Erro ao acessar a câmera:<br><b>${err.message}</b><br>
    <span>Feche/desative OBS, ManyCam, Snap Camera, DroidCam, etc. ou conecte uma webcam física.</span>`;
    console.error('Erro ao acessar a câmera:', err);
  }
}

function capturarFrameRedimensionado() {
  // Redimensiona para 320x240
  const canvas = document.createElement('canvas');
  canvas.width = 320;
  canvas.height = 240;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, 320, 240);
  return canvas;
}

function detectarRosto() {
  if (reconhecido) return;
  const canvas = capturarFrameRedimensionado();
  if (!canvas) {
    feedback.className = 'text-red-700 bg-red-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
    feedback.innerHTML = '<i class="ri-error-warning-line"></i> Erro ao capturar frame da câmera.';
    return;
  }
  canvas.toBlob(async function(blob) {
    if (!blob) {
      feedback.className = 'text-red-700 bg-red-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
      feedback.innerHTML = '<i class="ri-error-warning-line"></i> Erro ao converter imagem para blob.';
      return;
    }
    const formData = new FormData();
    formData.append('face_image', blob, 'face.jpg');
    try {
      const response = await fetch('/recepcao/api/verificar-face/', {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      if (
        data.success &&
        Array.isArray(data.faces_detected) &&
        data.faces_detected.length > 0 &&
        data.faces_detected[0].visitante_id &&
        !isNaN(Number(data.faces_detected[0].visitante_id)) &&
        Number(data.faces_detected[0].visitante_id) > 0
      ) {
        // Visitante reconhecido → finalizar visita
        reconhecido = true;
        feedback.className = 'text-green-700 bg-green-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
        feedback.innerHTML = '<i class="ri-check-line"></i> Visita finalizada com sucesso! Redirecionando...';
        setTimeout(() => {
          window.location.href = '/recepcao/totem/home/';
        }, 1500);
      } else if (
        data.success &&
        Array.isArray(data.faces_detected) &&
        data.faces_detected.length > 0
      ) {
        // Rosto detectado, mas não reconhecido
        reconhecido = true;
        feedback.className = 'text-yellow-700 bg-yellow-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
        feedback.innerHTML = '<i class="ri-user-add-line"></i> Rosto detectado, mas não reconhecido. Procure a recepção para finalizar.';
      } else if (data.error) {
        feedback.className = 'text-red-700 bg-red-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
        feedback.innerHTML = `<i class="ri-error-warning-line"></i> ${data.error}`;
        setTimeout(detectarRosto, 1500);
      } else {
        feedback.className = 'text-blue-700 bg-blue-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
        feedback.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Aguardando detecção facial...';
        setTimeout(detectarRosto, 1500);
      }
    } catch (e) {
      feedback.className = 'text-red-700 bg-red-50 rounded-lg px-3 py-2 flex items-center justify-center gap-2';
      feedback.innerHTML = '<i class="ri-error-warning-line"></i> Erro ao enviar imagem para o servidor.';
      setTimeout(detectarRosto, 2000);
    }
  }, 'image/jpeg', 0.8);
}

document.addEventListener('DOMContentLoaded', startCamera);
window.addEventListener('beforeunload', () => {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
});
</script>
{% endblock %} 